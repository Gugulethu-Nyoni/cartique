generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                            Int        @id @default(autoincrement())
  access_level                  Int        @default(1)
  name                          String?
  surname                       String?
  email                         String     @unique
  mobile                        String?
  password_hash                 String
  is_verified                   Boolean    @default(false)
  verification_token            String?    @db.VarChar(512)
  verification_token_expires_at DateTime?
  reset_token                   String?    @db.VarChar(512)
  reset_token_expires_at        DateTime?
  last_login_at                 DateTime?
  failed_login_attempts         Int        @default(0)
  status                        UserStatus @default(active)
  createdAt                     DateTime   @default(now()) @map("created_at")
  updatedAt                     DateTime   @default(now()) @updatedAt @map("updated_at")
  Customer                      Customer?
  deliveries                    Delivery[] @relation("DriverDeliveries")
  authLogs                      AuthLog[]
  sessions                      Session[]

  @@map("users")
}

model Session {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  token       String    @unique
  device_info String?   @map("device_info")
  ip_address  String?   @map("ip_address")
  is_revoked  Boolean   @default(false) @map("is_revoked")
  revoked_at  DateTime? @map("revoked_at")
  expires_at  DateTime  @map("expires_at")
  created_at  DateTime  @default(now()) @map("created_at")
  updated_at  DateTime  @updatedAt @map("updated_at")
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@index([expires_at])
  @@index([userId, is_revoked, expires_at], map: "idx_active_sessions")
  @@map("sessions")
}

model AuthLog {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  ip        String?  @map("ip_address")
  userAgent String?  @map("user_agent") @db.Text
  event     String   @map("action")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("auth_logs")
}

model CustomerAddress {
  id                Int      @id @default(autoincrement())
  company           String?
  city              String?
  state             String?
  country           String?
  phone             String?
  addressLine1      String?
  addressLine2      String?
  createdAt         DateTime @default(now())
  customerId        Int
  isDefaultBilling  Boolean  @default(true)
  isDefaultShipping Boolean  @default(true)
  postalCode        String?
  updatedAt         DateTime @default(now()) @updatedAt
  local_area        String?
  customer          Customer @relation("CustomerAddresses", fields: [customerId], references: [id])

  @@index([customerId])
}

model Product {
  id                Int               @id @default(autoincrement())
  sku               String?           @unique
  slug              String            @unique
  description       String?
  short_description String?
  status            Product_status    @default(draft)
  attributes        Json?             // Keep for backward compatibility
  metadata          Json?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @default(now()) @updatedAt
  currency          String            @default("ZAR")
  image             String?
  price             Decimal           @default(0.000000000000000000000000000000)
  sale_price        Decimal?
  title             String
  product_images    Json?
  length_cm         Float?            @db.Float
  width_cm          Float?            @db.Float
  height_cm         Float?            @db.Float
  weight_kg         Float?            @db.Float
  inventory         Int               @default(0)
  
  // NEW: Flag to distinguish simple vs variable products
  has_variants      Boolean           @default(false) @map("has_variants")
  
  // Relationships (kept all)
  orderItems        OrderItem[]
  media             ProductMedia[]
  reviews           ProductReview[]
  variants          ProductVariant[]
  categories        ProductCategory[] @relation("ProductToProductCategory")

  @@index([slug])
  @@index([status])
  @@index([has_variants])
  @@map("products")
}

model ProductVariant {
  id                Int               @id @default(autoincrement())
  productId         Int               @map("product_id")
  sku               String?           @unique
  price             Float
  compareAtPrice    Float?            @map("compare_at_price")
  costPrice         Float?            @map("cost_price")
  inventoryPolicy   InventoryPolicy   @default(deny) @map("inventory_policy")
  barcode           String?
  weight            Float?
  dimensions        Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @default(now()) @updatedAt @map("updated_at")
  isDefault         Boolean           @default(false) @map("is_default")
  variantAttributes VariantAttribute[]
  orderItems        OrderItem[]
  product           Product           @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, isDefault])
  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model VariantAttribute {
  id          Int             @id @default(autoincrement())
  variantId   Int             @map("variant_id")
  key         String          // Merchant-defined attribute name: "color", "size", "ram", etc.
  value       String          // Attribute value: "red", "XL", "16GB", etc.
  data_type   String?         @map("data_type") // Optional: "string", "number", "boolean", "color"
  sort_order  Int             @default(0) @map("sort_order")
  created_at  DateTime        @default(now()) @map("created_at")
  updated_at  DateTime        @default(now()) @updatedAt @map("updated_at")
  variant     ProductVariant  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  @@unique([variantId, key])
  @@index([key, value])      // Critical for filtering performance
  @@index([key])
  @@index([variantId])
  @@map("variant_attributes")
}

// Existing enums (keeping as-is)
enum Product_status {
  draft
  active
  archived
}

enum InventoryPolicy {
  deny
  continue
}

model ProductCategory {
  id          Int               @id @default(autoincrement())
  name        String
  slug        String            @unique
  description String?
  parent_id   Int?
  metadata    Json?
  sortOrder   Int               @default(0) @map("sort_order")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @default(now()) @updatedAt @map("updated_at")
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  products    Product[]         @relation("ProductToProductCategory")

  @@index([slug])
  @@index([parent_id])
}

model ProductMedia {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  url       String
  type      String
  altText   String?  @map("alt_text")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
}

model ProductReview {
  id         Int      @id @default(autoincrement())
  productId  Int      @map("product_id")
  customerId Int      @map("customer_id")
  rating     Int
  comment    String?  @db.Text
  status     String   @default("pending")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")
  customer   Customer @relation(fields: [customerId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([customerId])
  @@index([status])
}

model Order {
  id              Int         @id @default(autoincrement())
  orderNumber     String      @unique @map("order_number")
  customerId      Int?        @map("customer_id")
  status          OrderStatus @default(pending)
  currency        String
  subtotal        Float
  totalTax        Float       @default(0) @map("total_tax")
  totalShipping   Float       @default(0) @map("total_shipping")
  totalDiscounts  Float       @default(0) @map("total_discounts")
  total           Float
  billingAddress  Json        @map("billing_address")
  shippingAddress Json        @map("shipping_address")
  metadata        Json?
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @default(now()) @updatedAt @map("updated_at")
  hash            String?     @unique
  deliveries      Delivery[]
  customer        Customer?   @relation(fields: [customerId], references: [id])
  items           OrderItem[]
  payments        Payment[]

  @@index([orderNumber])
  @@index([customerId])
  @@index([status])
}

model OrderItem {
  id                  Int             @id @default(autoincrement())
  orderId             Int             @map("order_id")
  productId           Int             @map("product_id")
  variantId           Int?            @map("variant_id")
  quantity            Int
  price               Float
  taxLines            Json?           @map("tax_lines")
  discountAllocations Json?           @map("discount_allocations")
  metadata            Json?
  createdAt           DateTime        @default(now()) @map("created_at")
  order               Order           @relation(fields: [orderId], references: [id])
  product             Product         @relation(fields: [productId], references: [id])
  variant             ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId], map: "OrderItem_product_id_fkey")
  @@index([variantId], map: "OrderItem_variant_id_fkey")
}

model Checkout {
  id        String   @id @default(uuid())
  orderId   Int?
  status    String   @default("pending")
  sessionId String?
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Delivery {
  id                 Int            @id @default(autoincrement())
  orderId            Int            @map("order_id")
  customerId         Int?           @map("customer_id")
  trackingNumber     String?        @map("tracking_number")
  carrier            String?        @map("carrier")
  status             DeliveryStatus @default(pending)
  estimatedDate      DateTime?      @map("estimated_date")
  actualDate         DateTime?      @map("actual_date")
  deliveryAddress    Json           @map("delivery_address")
  notes              String?
  driverId           Int?           @map("driver_id")
  proofOfDelivery    String?        @map("proof_of_delivery")
  metadata           Json?
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @default(now()) @updatedAt @map("updated_at")
  quoteExpiresAt     DateTime?      @map("quote_expires_at")
  quotedShippingCost Float?         @map("quoted_shipping_cost")
  shippingCost       Float?         @map("shipping_cost")
  shippingMethod     String?        @map("shipping_method")
  shippingQuoteId    String?        @map("shipping_quote_id")
  shippingService    String?        @map("shipping_service")
  customer           Customer?      @relation(fields: [customerId], references: [id])
  driver             User?          @relation("DriverDeliveries", fields: [driverId], references: [id])
  order              Order          @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([customerId])
  @@index([status])
  @@index([driverId])
  @@index([shippingQuoteId])
}

model Payment {
  id             Int           @id @default(autoincrement())
  orderId        Int           @map("order_id")
  amount         Float
  currency       String
  paymentMethod  String        @map("payment_method")
  paymentGateway String        @map("payment_gateway")
  status         PaymentStatus @default(pending)
  transactionId  String?       @map("transaction_id")
  metadata       Json?
  createdAt      DateTime      @default(now()) @map("created_at")
  order          Order         @relation(fields: [orderId], references: [id])
  refunds        Refund[]

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
}

model Refund {
  id        Int      @id @default(autoincrement())
  paymentId Int      @map("payment_id")
  amount    Float
  reason    String?
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  payment   Payment  @relation(fields: [paymentId], references: [id])

  @@index([paymentId])
}

model DriverLocation {
  id        Int      @id @default(autoincrement())
  driverId  Int
  latitude  Float
  longitude Float
  timestamp DateTime @default(now())
}

model StoreSettings {
  id                    Int          @id @default(autoincrement())
  storeName             String       @default("My Store") @map("store_name")
  storeEmail            String?      @map("store_email")
  storePhone            String?      @map("store_phone")
  storeLogoUrl          String?      @map("store_logo_url")
  defaultCurrency       String       @default("ZAR") @map("default_currency")
  availableCurrencies   Json         @map("available_currencies")
  timezone              String       @default("Africa/Johannesburg") @map("timezone")
  locale                String       @default("en-ZA") @map("locale")
  siteMode              SiteMode     @default(test) @map("site_mode")
  checkoutMode          CheckoutMode @default(test) @map("checkout_mode")
  maintenanceMessage    String?      @map("maintenance_message") @db.Text
  lowStockThreshold     Int          @default(5) @map("low_stock_threshold")
  autoArchiveOrdersDays Int          @default(30) @map("auto_archive_orders_days")
  requireOrderApproval  Boolean      @default(false) @map("require_order_approval")
  paymentGateway        String       @default("yoco") @map("payment_gateway")
  isPaymentActive       Boolean      @default(true) @map("is_payment_active")
  shippingService       String       @default("courier_guy") @map("shipping_service")
  isShippingActive      Boolean      @default(true) @map("is_shipping_active")
  paymentConfig         Json         @map("payment_config")
  shippingConfig        Json         @map("shipping_config")
  defaultShippingRate   Float?       @default(0) @map("default_shipping_rate")
  freeShippingThreshold Float?       @map("free_shipping_threshold")
  metadata              Json?
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @default(now()) @updatedAt @map("updated_at")

  @@map("store_settings")
}

model Customer {
  id            Int               @id @default(autoincrement())
  phone         String?
  metadata      Json?
  createdAt     DateTime          @default(now())
  loyaltyPoints Int?              @default(0)
  updatedAt     DateTime          @default(now())
  userId        Int               @unique
  users         User              @relation(fields: [userId], references: [id])
  addresses     CustomerAddress[] @relation("CustomerAddresses")
  deliveries    Delivery[]
  orders        Order[]
  reviews       ProductReview[]
}

model Settings {
  id                       Int      @id @default(autoincrement())
  store_name               String   @default("My Store")
  store_email              String?
  store_phone              String?
  store_logo_url           String?
  default_currency         String   @default("USD")
  available_currencies     Json
  timezone                 String   @default("UTC")
  locale                   String   @default("en-US")
  warehouses               Json
  pickup_locations         Json
  default_warehouse_id     Int?
  auto_archive_orders_days Int      @default(30)
  require_order_approval   Boolean  @default(false)
  low_stock_threshold      Int      @default(5)
  default_payment_gateway  String?
  payment_gateways         Json
  checkout_fields          Json
  notification_settings    Json
  is_maintenance_mode      Boolean  @default(false)
  maintenance_message      String?
  api_settings             Json
  webhook_urls             Json
  metadata                 Json?
  created_at               DateTime @default(now())
  updated_at               DateTime @default(now())

  @@index([default_warehouse_id])
}

enum UserStatus {
  active
  locked
  suspended
}

enum SiteMode {
  test
  live
  maintenance
}

enum CheckoutMode {
  test
  live
}

enum InventoryPolicy {
  deny
  continue
}

enum OrderStatus {
  pending
  processing
  completed
  cancelled
  refunded
}

enum PaymentStatus {
  pending
  authorized
  paid
  failed
  refunded
}

enum Product_status {
  draft
  active
  archived
}

enum DeliveryStatus {
  pending
  processing
  ready_for_pickup
  in_transit
  out_for_delivery
  delivered
  failed
  returned
}
